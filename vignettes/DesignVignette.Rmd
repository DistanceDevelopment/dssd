---
title: "Design Vignette: dsuds"
author: "Laura Marshall"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Design Vignette: dsuds}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

'dsuds' is a package for designing distance sampling surveys in R. It currently offers a number of design options: systematic points, systematic lines, randomly lines, equal spaced zigzagz and equal spaces zigzags with complement lines. Different types of line transect designs may be used in different strata.

## Defining the Study Area

Users can define a study area by either passing in a pathway to a shapefile or providing a polygon / multipolygon shape of class sf or sfc (see 'sf' R library). Other options will be added in the future including the option to provide sp objects, data frames or lists of data frames.

The user can provide a region name and names for strata if applicable. If no strata names are provided and the study area has multiple strata these will be automatically assigned as letters of the alpabet.

```{r scansIIarea, fig.asp = 1}
library(dsuds)
region <- make.region(region.name = "study.area", shape = "/Users/lhm/Documents/GitHub/dsuds/dsuds/inst/extdata/shape/strata.shp")
plot(region)
```


If no shape is supplied for the region The design package will make a default study area with the same dimensions as that in the simulation package 'DSsim' 2000 x 500.

```{r defaultregion, fig.asp = 1}
default.region <- make.region()
plot(default.region)
```


\newpage

## Defining the Design

'dsuds' can generate two types of transect designs: points and lines. The default design is 20 systematic parallel lines with a design angle of 0, meaning that the lines run perpendicular to the x axis. 

```{r defaultdesign, fig.asp = 1}
default.design <- make.design(default.region)
transects <- generate.transects(default.design)
plot(default.region, transects, lwd = 1.5, col = 4)

```

\newpage

## Point transect surveys

I have implemented the systematic point transect design. This design can have different design arguments such as spacing, design.angle, no.samplers and  plus/minus sampling for each strata. I have yet to implement the summary methods for the point transect objects so I have included details about what I will show.

```{r point, fig.asp = 1}

region <- make.region("study area", c("A", "B"), shape = "/Users/lhm/Documents/Work/design package/sf investigations/strata.shp")
design <- make.design(region, transect.type = "point", 
                      design = "systematic", 
                      spacing = c(1,2), 
                      edge.protocol = c("plus", "minus"), 
                      design.angle = c(0,45),
                      truncation = 1)
transects <- generate.transects(design)
transects
plot(region, transects)


```

\newpage

The next example uses the desired number of samplers to determine the spacing. In this example the spacing is based on a calculation involving the strata area however in the case of plus sampling should this calculation be based on the buffered survey region? Otherwise it will generate many more than the desired number of points.

```{r point2, fig.asp = 1}

design <- make.design(region, "point", "systematic", 
                      samplers = c(20,20), 
                      edge.protocol = c("minus"), 
                      design.angle = c(0,45),
                      truncation = 1)
transects <- generate.transects(design)
transects
plot(region, transects, covered.area = TRUE)


```

This next example demonstrates when the user would like even coverage and would like to define the desired number of samplers across the entire study region rather than by strata.


```{r pointtotalsamplers, fig.asp = 1}

design <- make.design(region, "point", "systematic", 
                      samplers = c(40), 
                      edge.protocol = c("minus"),
                      design.angle = c(0,45),
                      truncation = 1)
transects <- generate.transects(design)
transects
plot(region, transects, covered.area = TRUE)


```

```{r pointmissampspace, fig.asp = 1}

design <- make.design(region, "point", "systematic", 
                      samplers = c(20, NA),
                      spacing = c(NA, 2),
                      edge.protocol = c("minus"), 
                      design.angle = c(45),
                      truncation = 0.75)
transects <- generate.transects(design)
transects
plot(region, transects, covered.area = TRUE)


```
```{r pointtotalsamplerswitheffortallocation, fig.asp = 1}

design <- make.design(region, "point", "systematic", 
                      samplers = c(40),
                      effort.allocation = c(0.25,0.75),
                      edge.protocol = c("minus"), 
                      design.angle = 45,
                      truncation = 1)
transects <- generate.transects(design)
transects
plot(region, transects, covered.area = TRUE)


```


Let us now assess the coverage of a design. It is reccommended that you make a coverage grid and pass it to the make.design function. Doing it this way can be more memory efficient if you are trying multiple designs in the same study region. If you have not passed in a coverage grid when you make the design then when you try to run the coverage you will get a warning and a default grid with 1000 points will be generated. This example demonstrated the difference in coverage around the stratum boundaries with plus and minus sampling.

```{r pointcoverage, results='hide'}

region <- make.region("study area", c("A", "B"), shape = "/Users/lhm/Documents/Work/design package/sf investigations/strata.shp")
cover <- make.coverage(region, n.grid.point = 500)
design <- make.design(region, transect.type = "point", 
                      design = "systematic", 
                      spacing = c(2,2), 
                      edge.protocol = c("plus", "minus"), 
                      design.angle = c(0,0),
                      truncation = 1,
                      coverage.grid = cover)
design <- run.coverage(design, reps = 50)

```
```{r pointcoverageresults, fig.asp = 1}
design
plot(design)
```


\newpage

## Line transect surveys

This next section deals with line transect surveys. Currently the design package implements 4 types of line transect design: random parallel lines, systematic parallel lines, equal spaced zigzag and equal spaced zigzag with complement lines. Here we use a study region from the SCANS II survey to demonstrate how different designs can be used in different strata.

```{r strata, echo=TRUE, fig.asp = 1}

region <- make.region("region", shape = "/Users/lhm/Documents/GitHub/dsuds/dsuds/inst/extdata/shape/strata.shp")
plot(region)

```


```{r mixdesign, echo=TRUE, fig.asp = 1}

cover <- make.coverage(region, n.grid.points = 1000)
design.mix <- make.design(region,
                          transect.type = "line",
                          design = c(rep("systematic", 2), "eszigzag", "random", 
                                     rep("eszigzagcom",2), "systematic"),
                          spacing = c(20000, NA, 20000, NA, 34000, 34000, 20000),
                          samplers = c(NA, 11, NA, 12, NA, NA, NA),
                          design.angle = c(85, 100, 145, 110, 135, 140, 150),
                          bounding.shape = c(NA, NA, "convex.hull", NA, 
                                             "convex.hull", "rectangle", NA),
                          edge.protocol = rep("minus", 7),
                          truncation = 7500,
                          coverage.grid = cover)
set.seed(555)
transects.mix <- generate.transects(design.mix)
plot(region, transects.mix, col = 4, covered.area = T)

```

```{r mixdesigncoverage, echo=TRUE, fig.asp = 1, results='hide'}

design.mix <- run.coverage(design.mix, reps = 50)


```

```{r mixdesigncoverageresults, echo=TRUE, fig.asp = 1}

design.mix
plot(design.mix)

```

### Appendices

## Manual creation of study areas

Example of creating a study region manually. This example code is taken from the help file for 'sf::st_multipolygon'. To create an sf polygon or multipolygon you first need to create 1 or more matrices of coordinates representing the outer polygons and any holes. For multipolygons the outer polygons and holes are defined by their placement within their list element, only the first matrix in a list element is an outer polygon then all the following matrices are holes. In the following example all polygons would be considered to be in the same strata.

```{r makeown, fig.asp = 1}
outer <- matrix(c(0,0,15,0,15,10,0,10,0,0),ncol=2, byrow=TRUE)
hole1 <- matrix(c(2,2,2,3,3,3,3,2,2,2),ncol=2, byrow=TRUE)
hole2 <- matrix(c(5,5,5,6,7,6,8,5.5,7,5,5,5),ncol=2, byrow=TRUE)
pol1 <- list(outer, hole1*1.5, hole2)
pol2 <- list(outer + 15, hole2*1.5 + 12)
pol3 <- list(outer + 30, hole2*2.5 + 20)
mp <- list(pol1,pol2,pol3)
mp1 <- sf::st_multipolygon(mp)

region <- make.region(region.name = "study.area", shape = mp1)
plot(region)
```


If instead you wanted to create the 3 separate polygons as 3 distinct strata you could use the following code:

```{r makeown2, fig.asp = 1}
outer <- matrix(c(0,0,15,0,15,10,0,10,0,0),ncol=2, byrow=TRUE)
hole1 <- matrix(c(2,2,2,3,3,3,3,2,2,2),ncol=2, byrow=TRUE)
hole2 <- matrix(c(5,5,5,6,7,6,8,5.5,7,5,5,5),ncol=2, byrow=TRUE)
pol1 <- sf::st_polygon(list(outer, hole1*1.5, hole2))
pol2 <- sf::st_polygon(list(outer + 15, hole2*1.5 + 12))
pol3 <- sf::st_polygon(list(outer + 30, hole2*2.5 + 20))
sfc <- sf::st_sfc(pol1,pol2,pol3)
strata.names <- c("SW", "central", "NE")
mp1 <- sf::st_sf(strata = strata.names, geom = sfc)

region <- make.region(region.name = "study.area", 
                      strata.name = strata.names, 
                      shape = mp1)
plot(region)
```



